<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{% if page.title %}{{ page.title | escape }} - {{ site.title | escape | split: "|" | first }} {% else %}{{ site.title | escape }}{% endif %}</title>
  <meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">

  <!-- Preconnect for performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Fonts: Playfair Display (display) + DM Sans (body) + JetBrains Mono (code) -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="{{ "/css/main.css" | prepend: site.baseurl }}?v=2">
  <link rel="canonical" href="{{ page.url | replace:'index.html','' | prepend: site.baseurl | prepend: site.url }}">
  <link rel="alternate" type="application/rss+xml" title="{{ site.title }}" href="{{ "/feed.xml" | prepend: site.baseurl | prepend: site.url }}">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">

  <!-- Prevent flash of wrong theme -->
  <script>
    (function() {
      const theme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- MathJax for equations -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>

  <!-- Mermaid diagrams -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

    function getMermaidTheme() {
      return document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default';
    }

    function initMermaid() {
      mermaid.initialize({
        startOnLoad: false,
        look: 'handDrawn',
        theme: getMermaidTheme(),
        handDrawnSeed: 42
      });
    }

    function renderMermaid() {
      document.querySelectorAll('pre > code.language-mermaid').forEach(function(code) {
        const pre = code.parentElement;
        pre.className = 'mermaid';
        pre.removeAttribute('data-processed');
        pre.textContent = code.textContent;
      });
      mermaid.run();
    }

    initMermaid();
    document.addEventListener('DOMContentLoaded', renderMermaid);

    window.addEventListener('themechange', function() {
      initMermaid();
      document.querySelectorAll('.mermaid').forEach(el => {
        el.removeAttribute('data-processed');
      });
      mermaid.run();
    });

    window.refreshMermaid = function() {
      initMermaid();
      document.querySelectorAll('.mermaid').forEach(el => {
        el.removeAttribute('data-processed');
      });
      mermaid.run();
    };
  </script>

  <!-- Theme toggle script -->
  <script>
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      // Update toggle button icon
      const toggleBtn = document.querySelector('.theme-toggle');
      if (toggleBtn) {
        const sunIcon = toggleBtn.querySelector('.icon-sun');
        const moonIcon = toggleBtn.querySelector('.icon-moon');
        if (sunIcon && moonIcon) {
          sunIcon.style.display = theme === 'dark' ? 'block' : 'none';
          moonIcon.style.display = theme === 'dark' ? 'none' : 'block';
        }
      }

      // Dispatch event for other components
      window.dispatchEvent(new CustomEvent('themechange', { detail: { theme } }));
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      setTheme(savedTheme);

      // Mobile menu toggle
      const menuToggle = document.querySelector('.menu-toggle');
      const mobileNav = document.querySelector('.mobile-nav');
      if (menuToggle && mobileNav) {
        menuToggle.addEventListener('click', function() {
          mobileNav.classList.toggle('is-open');
          menuToggle.setAttribute('aria-expanded',
            mobileNav.classList.contains('is-open'));
        });
      }
    });
  </script>

  {% if site.tags != "" %}
  {% include collect-tags.html %}
  {% endif %}

  {% if jekyll.environment == 'production' %}
  {% include analytics.html %}
  {% endif %}
</head>
